#!/bin/bash
# slug-files - Batch rename files to URL/filename-friendly slugs
#
# Version: 1.0.1
# 
# Changelog:
# 1.0.1 - Fixed max_len default to 0 (was 255), removed unused stop_words feature
# 1.0.0 - Initial release
#
#shellcheck disable=SC1091
set -euo pipefail
declare -- PRG0 PRG PRGDIR
PRG0=$(readlink -en -- "$0")
PRG=$(basename -- "$PRG0")
PRGDIR=$(dirname -- "$PRG0")
declare -i VERBOSE=1

usage() {
  echo "$PRG [-s|--sep_char CHAR] [-m|--max-len LEN] [-p|--preserve-case] [-n|--no-clobber] [-q|--quiet] file [file...]"
  echo "Rename files to post-slug format"
  echo "eg, $PRG -pn /a/directory/*.txt"
  exit
}

info() { >&2 echo "$PRG:" "${1:-}"; >&2 echo; }
die() { >&2 echo "$PRG:" 'error:' "${2:-}"; exit "${1:-1}"; }

declare -a Files=()
declare -- sep_char='-'
declare -i preserve_case=0 max_len=0 clobber=1
declare -- file dirname ext newfile

source post_slug.bash 2>/dev/null || {
  source "$PRGDIR"/post_slug.bash || die 1 "post_slug.bash not found in PATH or $PRGDIR"
}

while (($#)); do case "$1" in
  -s|--sep_char)
      shift
      sep_char="${1:--}"
      sep_char="${sep_char:0:1}"
      ;;
  -m|--max-len)
      shift
      max_len="${1:-0}"
      if ((max_len>255)); then
        max_len=255
      fi
      if ((max_len<0)); then
        max_len=0
      fi
      ;;
  -p|--preserve-case) preserve_case=1 ;;
  -n|--no-clobber) clobber=0 ;;
  -v|--verbose) VERBOSE=1 ;;
  -q|--quiet) VERBOSE=0 ;;
  -h|--help) usage ;;
  -[smpnvqh]*) #shellcheck disable=SC2046 #split up single options
      set -- '' $(printf -- "-%c " $(grep -o . <<<"${1:1}")) "${@:2}" ;;
  -*) die 22 "Invalid option '$1'" ;;
  *)  Files+=("$1") ;;
esac; shift; done

((${#Files[@]})) || die 1 "No files found."

info "WARNING: ${#Files[@]} files will be RENAMED in post-slug format!"
read -rp "$PRG: Proceed? y/n "; [[ $REPLY == y ]] || exit 1
>&2 echo

for file in "${Files[@]}"; do
  file=$(readlink -en -- "$file")
  dirname=$(dirname -- "$file")
  newfile=$(basename "$file")
  ext=''
  if [[ $newfile == *"."* ]]; then
    ext=".${newfile##*.}"
    newfile=$(basename -s "$ext" "$newfile")
  fi

  slug=$(post_slug "$newfile" "$sep_char" "$preserve_case" "$max_len")
  if [[ -z $slug ]]; then
    info "WARNING: Zero length slug for '$file'"
    continue
  fi
  newfile="$dirname/$slug$ext"

  if [[ $newfile == "$file" ]]; then
    ((!VERBOSE)) || info "No change required for $file"
    continue
  fi

  if [[ -f $newfile ]] && ((!clobber)); then
    info "File '$(basename -- "$newfile")' already slugged"
    continue
  fi

  ((!VERBOSE)) || info "mv $file -> $newfile"
  mv "$file" "$newfile" || die 1 "Error moving '$file' to '$newfile'"
done

#fin
